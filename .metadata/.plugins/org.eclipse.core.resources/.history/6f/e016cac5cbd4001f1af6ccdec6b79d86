package com.ecom.util;

import java.io.File;
import java.io.UnsupportedEncodingException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Component;

import com.ecom.model.ProductOrder;

import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeMessage;
import jakarta.servlet.http.HttpServletRequest;

@Component
public class CommonUtil {

	@Autowired
	private JavaMailSender mailSender;

	public Boolean sendMail(String url, String recipientEmail, String recieverName)
			throws UnsupportedEncodingException, MessagingException {

		MimeMessage message = mailSender.createMimeMessage();
		MimeMessageHelper helper = new MimeMessageHelper(message);

		helper.setFrom("chamidukeshikaz@gmail.com", "Shopping App Support Team");
		helper.setTo(recipientEmail);

		String content = "<html>" + "<head>" + "<style>"
				+ "    body { font-family: Arial, sans-serif; color: #333333; }"
				+ "    .email-header { background-color: #4CAF50; color: white; padding: 10px 20px; text-align: center; }"
				+ "    .email-body { margin: 20px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 5px; }"
				+ "    .email-footer { margin-top: 20px; font-size: 12px; color: #888888; text-align: center; }"
				+ "    a { color: #4CAF50; text-decoration: none; font-weight: bold; }" + "</style>" + "</head>"
				+ "<body>" + "    <div class=\"email-header\">" + "        <h1>Password Reset Request</h1>"
				+ "    </div>" + "    <div class=\"email-body\">" + "        <p>Dear " + recieverName + ",</p>"
				+ "        <p>We received a request to reset your password for your <strong>Shopping App</strong> account. If you made this request, you can reset your password by clicking the button below:</p>"
				+ "        <p style=\"text-align: center;\">" + "            <a href=\"" + url
				+ "\" style=\"background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: inline-block;\">Reset Password</a>"
				+ "        </p>"
				+ "        <p>If you did not request to reset your password, please ignore this email. Your account is safe, and no changes have been made.</p>"
				+ "        <p>For any assistance, please contact our support team at <a href=\"mailto:support@shoppingapp.com\">support@shoppingapp.com</a>.</p>"
				+ "        <p>Thank you,<br>The Shopping App Team</p>" + "    </div>"
				+ "    <div class=\"email-footer\">"
				+ "        <p>This email was sent to you because a password reset request was initiated for your account. If you believe this was a mistake, please disregard this email.</p>"
				+ "        <p>&copy; 2025 Shopping App. All rights reserved.</p>" + "    </div>" + "</body>"
				+ "</html>";

		helper.setSubject("Reset Your Shopping App Password");
		helper.setText(content, true);
		mailSender.send(message);

		return true;
	}

	public static String generateUrl(HttpServletRequest request) {

		// http://localhost:8080/forgot-password
		String siteUrl = request.getRequestURL().toString();

		return siteUrl.replace(request.getServletPath(), "");

	}

	String msg = "<div style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">"
			+ "<h2 style=\"color: #5b9bd5;\">Dear [[name]],</h2>"
			+ "<p>We are pleased to inform you about the status of your recent order:</p>"
			+ "<h3 style=\"color: #4caf50;\">Order Status: [[orderStatus]]</h3>"
			+ "<p>Below are the details of your purchase:</p>"
			+ "<table style=\"border: 1px solid #ddd; border-collapse: collapse; width: 100%;\">"
			+ "    <tr style=\"background-color: #f9f9f9;\">"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\">"
			+ "            <strong>Product Image:</strong>" + "        </td>"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\">"
			+ "            <img src=\"[[image]]\" style=\"max-height: 100px; max-width: 100px; border-radius: 10px; object-fit: cover;\" alt=\"Product Image\">"
			+ "        </td>" + "    </tr>" + "    <tr>"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\"><strong>Product Name:</strong></td>"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\">[[productName]]</td>" + "    </tr>"
			+ "    <tr style=\"background-color: #f9f9f9;\">"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\"><strong>Category:</strong></td>"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\">[[category]]</td>" + "    </tr>" + "    <tr>"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\"><strong>Quantity:</strong></td>"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\">[[quantity]]</td>" + "    </tr>"
			+ "    <tr style=\"background-color: #f9f9f9;\">"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\"><strong>Price:</strong></td>"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\">[[price]]</td>" + "    </tr>" + "    <tr>"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\"><strong>Payment Type:</strong></td>"
			+ "        <td style=\"padding: 8px; border: 1px solid #ddd;\">[[paymentType]]</td>" + "    </tr>"
			+ "</table>"
			+ "<p>If you have any questions or concerns, feel free to contact our support team at any time.</p>"
			+ "<p>Thank you for shopping with us!</p>" + "<p><strong>Shopping App Support Team</strong></p>" + "</div>";

	public Boolean sendMailForProductOrder(ProductOrder order, String status) throws Exception {
		MimeMessage message = mailSender.createMimeMessage();
		MimeMessageHelper helper = new MimeMessageHelper(message, true); // Set true for multipart email

		helper.setFrom("chamidukeshikaz@gmail.com", "Shopping App Support Team");
		helper.setTo(order.getOrderAddress().getEmail());

		// Replace placeholders with actual values
		msg = msg.replace("[[name]]", order.getOrderAddress().getFirstName());
		msg = msg.replace("[[orderStatus]]", status);
		msg = msg.replace("[[productName]]", order.getProduct().getTitle());
		msg = msg.replace("[[category]]", order.getProduct().getCategory());
		msg = msg.replace("[[quantity]]", order.getQuantity().toString());
		msg = msg.replace("[[price]]", order.getProduct().getPrice().toString());
		msg = msg.replace("[[paymentType]]", order.getPaymentType());
		File image = new File("/img/product_img/" + order.getProduct().getImage());
		msg = msg.replace("[[image]]", image.toString());

		// File image = "'/img/product_img/' " + "'{order.getProduct().getimage()}}'";

		helper.setSubject("Product Order Status");
		helper.setText(msg, true); // true for HTML content
		mailSender.send(message);

		return true;
	}

}

// 34min